<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex Game</title>
</head>
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .container {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        position: relative;
    }

    .score {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 24px;
        font-family: Arial, sans-serif;
        z-index: 10;
    }
</style>

<body>
    <div class="container">
        <div class="score">Score: 0</div>
    </div>
    <script>
        class Enviroment {
            constructor(x) {
                this.x = x;
                this.image = new Image();
                this.image.src = "./enviroment.png";
                this.image.onload = () => {
                    this.imageLoaded = true;
                }
                this.imageLoaded = false;
            }
        }

        class Cactus {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.image = new Image();
                this.image.src = "./cactus.png";
                this.image.onload = () => {
                    this.imageLoaded = true;
                }
                this.imageLoaded = false;
                this.width = 200;
                this.height = 200;
                this.scored = false; // Para evitar sumar múltiples puntos por el mismo cactus
            }

            update() {
                this.x -= 5; // Movimiento constante hacia la izquierda
            }

            isOffScreen() {
                return this.x + this.width < 0; // Si se sale de la pantalla
            }
        }

        class Rex {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.image1 = new Image();
                this.image1.src = "./trex1.png";
                this.image2 = new Image();
                this.image2.src = "./trex2.png";
                this.image1Loaded = false;
                this.image2Loaded = false;
                this.image1.onload = () => {
                    this.image1Loaded = true;
                };
                this.image2.onload = () => {
                    this.image2Loaded = true;
                };
                this.currentImage = this.image1;
                this.lastSwitchTime = 0;
                this.switchInterval = 100;
                this.jump = undefined;
                this.gravity = 0.5;
                this.jumpPower = 15; // Incrementado para saltar más alto
                this.width = 200;
                this.height = 200;
            }

            update(deltaTime) {
                this.lastSwitchTime += deltaTime;
                if (this.lastSwitchTime >= this.switchInterval) {
                    this.currentImage = this.currentImage === this.image1 ? this.image2 : this.image1;
                    this.lastSwitchTime = 0;
                }

                if (this.jump) {
                    this.y -= this.jumpPower;
                    this.jumpPower -= this.gravity;
                    if (this.y >= window.innerHeight - 300) {
                        this.jump = undefined;
                        this.y = window.innerHeight - 300;
                        this.jumpPower = 15; // Reiniciar salto
                    }
                }
            }

            // Nueva función para calcular la distancia horizontal al cactus
            horizontalDistance(cactus) {
                return Math.abs(this.x + this.width - cactus.x);
            }

            checkCollision(cactus) {
                const distance = this.horizontalDistance(cactus);

                // Permitir superar si está saltando y la distancia está entre 50 y 100 píxeles
                if (distance <= 100 && distance >= 50 && this.jump) {
                    return false; // No hay colisión
                }

                return (
                    this.x < cactus.x + cactus.width &&
                    this.x + this.width > cactus.x &&
                    this.y < cactus.y + cactus.height &&
                    this.y + this.height > cactus.y
                );
            }

            isAbove(cactus) {
                return (
                    this.x + this.width > cactus.x &&
                    this.x < cactus.x + cactus.width &&
                    this.y + this.height <= cactus.y + 10 // Margen para evitar errores
                );
            }
        }
        const enviroment = new Enviroment(0);
        const rex = new Rex(100, window.innerHeight - 300);
        const cacti = [];
        let score = 0;
        let gameOver = false;
        let lastFrameTime = 0;
        let cactusSpawnInterval = 2000;
        let lastCactusSpawn = 0;

        const scoreElement = document.querySelector(".score");
        function updateScore() {
            scoreElement.textContent = `Score: ${score}`;
        }

        function spawnCactus() {
            const cactus = new Cactus(window.innerWidth, window.innerHeight - 250);
            cacti.push(cactus);
        }

        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            if (!enviroment.imageLoaded || !rex.image1Loaded || !rex.image2Loaded) {
                requestAnimationFrame(gameLoop);
                return;
            }

            if (gameOver) {
                alert(`Game Over! Final Score: ${score}`);
                return;
            }

            if (timestamp - lastCactusSpawn > cactusSpawnInterval) {
                spawnCactus();
                lastCactusSpawn = timestamp;
            }

            enviroment.x -= 1;
            if (enviroment.x < -window.innerWidth) {
                enviroment.x = 0;
            }
            rex.update(deltaTime);
            cacti.forEach((cactus) => cactus.update());

            for (let i = cacti.length - 1; i >= 0; i--) {
                if (cacti[i].isOffScreen()) {
                    cacti.splice(i, 1);
                } else if (rex.checkCollision(cacti[i])) {
                    gameOver = true;
                } else if (rex.isAbove(cacti[i]) && !cacti[i].scored) {
                    score += 10; // Incrementar score si salta sobre el cactus
                    updateScore();
                    cacti[i].scored = true; // Marcar como "contado"
                }
            }

            const canvas = document.createElement("canvas");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(enviroment.image, enviroment.x, 0, canvas.width, canvas.height);
            ctx.drawImage(enviroment.image, enviroment.x + canvas.width, 0, canvas.width, canvas.height);
            ctx.drawImage(rex.currentImage, rex.x, rex.y, rex.width, rex.height);
            cacti.forEach((cactus) => {
                if (cactus.imageLoaded) {
                    ctx.drawImage(cactus.image, cactus.x, cactus.y, cactus.width, cactus.height);
                }
            });

            const container = document.querySelector(".container");
            container.innerHTML = "";
            container.appendChild(canvas);

            requestAnimationFrame(gameLoop);
        }

        document.addEventListener("keydown", (e) => {
            if (e.key === " ") {
                if (!rex.jump) rex.jump = true;
            }
        });

        requestAnimationFrame(gameLoop);
    </script>
</body>

</html>